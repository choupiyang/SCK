import React, { useState, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import MarkdownRenderer from './MarkdownRenderer';
import './BatchImageOCR.css';

function BatchImageOCR() {
  const [images, setImages] = useState([]);
  const [results, setResults] = useState([]);
  const [processing, setProcessing] = useState(false);
  const [error, setError] = useState('');
  const fileInputRef = useRef(null);

  const handleFileSelect = (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    const validFiles = files.filter(file => {
      if (!file.type.startsWith('image/')) {
        return false;
      }
      if (file.size > 10 * 1024 * 1024) {
        return false;
      }
      return true;
    });

    if (validFiles.length === 0) {
      setError('æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
      return;
    }

    if (validFiles.length < files.length) {
      setError(`${files.length - validFiles.length} ä¸ªæ–‡ä»¶è¢«è·³è¿‡ï¼ˆéå›¾ç‰‡æˆ–è¶…è¿‡10MBï¼‰`);
    } else {
      setError('');
    }

    const newImages = validFiles.map(file => ({
      id: `${Date.now()}-${Math.random()}`,
      file,
      preview: URL.createObjectURL(file),
      status: 'pending',
    }));

    setImages(prev => [...prev, ...newImages]);
    setResults([]);
  };

  const handleRemoveImage = (id) => {
    setImages(prev => {
      const img = prev.find(i => i.id === id);
      if (img) {
        URL.revokeObjectURL(img.preview);
      }
      return prev.filter(img => img.id !== id);
    });
  };

  const handleProcessAll = async () => {
    if (images.length === 0) {
      setError('è¯·å…ˆæ·»åŠ å›¾ç‰‡');
      return;
    }

    setProcessing(true);
    setError('');
    setResults([]);

    const formData = new FormData();
    images.forEach(img => {
      formData.append('images', img.file);
    });

    try {
      const response = await fetch('/api/ocr/batch', {
        method: 'POST',
        body: formData,
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'å¤„ç†å¤±è´¥');
      }

      if (data.success) {
        setResults(data.results);

        setImages(prev => prev.map(img => {
          const result = data.results.find(r => r.filename === img.file.name);
          return {
            ...img,
            status: result?.success ? 'success' : 'error',
          };
        }));
      }
    } catch (err) {
      setError(err.message || 'å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setProcessing(false);
    }
  };

  const handleDownloadAll = () => {
    if (results.length === 0) return;

    let combinedMarkdown = `# æ‰¹é‡ OCR ç»“æœ\n\n`;
    combinedMarkdown += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n\n`;
    combinedMarkdown += `---\n\n`;

    results.forEach((result, index) => {
      if (result.success) {
        combinedMarkdown += `## ${result.filename}\n\n`;
        combinedMarkdown += `${result.markdown}\n\n`;
        combinedMarkdown += `---\n\n`;
      }
    });

    const blob = new Blob([combinedMarkdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `batch-ocr-${Date.now()}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleDownloadSingle = (result) => {
    if (!result.markdown) return;

    const blob = new Blob([result.markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${result.filename}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleReset = () => {
    images.forEach(img => URL.revokeObjectURL(img.preview));
    setImages([]);
    setResults([]);
    setError('');
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const successCount = results.filter(r => r.success).length;
  const failCount = results.filter(r => !r.success).length;

  return (
    <div className="batch-ocr">
      {/* Upload Section */}
      <motion.div
        className="upload-section memphis-card"
        initial={{ opacity: 0, y: 50, scale: 0.9 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        transition={{ duration: 0.6, type: 'spring', stiffness: 100 }}
      >
        <input
          ref={fileInputRef}
          type="file"
          accept="image/*"
          multiple
          directory=""
          webkitdirectory=""
          onChange={handleFileSelect}
          className="file-input"
          id="batch-image-upload"
          disabled={processing}
        />
        <motion.label
          htmlFor="batch-image-upload"
          className="upload-label"
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
        >
          <motion.div
            className="upload-icon"
            animate={{
              rotate: [0, 15, -15, 0],
              scale: [1, 1.1, 1]
            }}
            transition={{ duration: 2, repeat: Infinity, repeatDelay: 0.5 }}
          >
            ğŸ“š
          </motion.div>
          <div className="upload-text">é€‰æ‹©å›¾ç‰‡æˆ–æ•´ä¸ªç›®å½•</div>
          <div className="upload-hint">æ”¯æŒé€‰æ‹©å¤šä¸ªæ–‡ä»¶æˆ–æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œæ— æ•°é‡é™åˆ¶</div>
        </motion.label>

        <AnimatePresence>
          {images.length > 0 && (
            <motion.div
              className="batch-actions"
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
            >
              <motion.div
                className="batch-info"
                initial={{ x: -20 }}
                animate={{ x: 0 }}
              >
                å·²é€‰æ‹© <span className="count-badge">{images.length}</span> å¼ å›¾ç‰‡
              </motion.div>

              {!processing ? (
                <div className="batch-buttons">
                  <motion.button
                    className="action-btn memphis-btn secondary"
                    onClick={handleReset}
                    whileHover={{ scale: 1.05 }}
                    whileTap={{ scale: 0.95 }}
                  >
                    æ¸…ç©º
                  </motion.button>
                  <motion.button
                    className="action-btn memphis-btn"
                    onClick={handleProcessAll}
                    whileHover={{ scale: 1.05 }}
                    whileTap={{ scale: 0.95 }}
                  >
                    å¼€å§‹å¤„ç†
                  </motion.button>
                </div>
              ) : (
                <motion.div
                  className="processing-indicator"
                  initial={{ scale: 0 }}
                  animate={{ scale: 1 }}
                  transition={{ type: 'spring', stiffness: 200 }}
                >
                  <motion.div
                    className="spinner"
                    animate={{ rotate: 360 }}
                    transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
                  >
                    âš™ï¸
                  </motion.div>
                  <span>å¤„ç†ä¸­...</span>
                </motion.div>
              )}
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>

      {/* Error Message */}
      <AnimatePresence>
        {error && (
          <motion.div
            className="error-message"
            initial={{ opacity: 0, x: -100 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: 100 }}
            transition={{ type: 'spring', stiffness: 200 }}
          >
            <motion.span
              className="error-icon"
              animate={{ rotate: [0, -10, 10, -10, 0] }}
              transition={{ duration: 0.5 }}
            >
              âš ï¸
            </motion.span>
            {error}
          </motion.div>
        )}
      </AnimatePresence>

      {/* Images Grid */}
      <AnimatePresence>
        {images.length > 0 && (
          <motion.div
            className="images-grid"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            {images.map((image, index) => (
              <motion.div
                key={image.id}
                className="image-item"
                initial={{ scale: 0, rotate: -180 }}
                animate={{ scale: 1, rotate: 0 }}
                exit={{ scale: 0, rotate: 180 }}
                transition={{
                  delay: index * 0.05,
                  type: 'spring',
                  stiffness: 200,
                  damping: 20
                }}
                whileHover={{ y: -5, rotate: 2 }}
              >
                <div className="image-preview">
                  <img src={image.preview} alt={image.file.name} />
                  <motion.button
                    className="remove-btn"
                    onClick={() => handleRemoveImage(image.id)}
                    disabled={processing}
                    whileHover={{ scale: 1.2, rotate: 90 }}
                    whileTap={{ scale: 0.8 }}
                  >
                    âœ•
                  </motion.button>
                  <div className={`status-badge ${image.status}`}>
                    {image.status === 'success' && 'âœ“'}
                    {image.status === 'error' && 'âœ—'}
                    {image.status === 'pending' && 'ç­‰å¾…ä¸­'}
                  </div>
                </div>
                <div className="image-name">{image.file.name}</div>
              </motion.div>
            ))}
          </motion.div>
        )}
      </AnimatePresence>

      {/* Results Section */}
      <AnimatePresence>
        {results.length > 0 && (
          <motion.div
            className="results-section memphis-card"
            initial={{ opacity: 0, y: 100 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -100 }}
            transition={{ duration: 0.8, type: 'spring', stiffness: 100 }}
          >
            <div className="results-header">
              <motion.h3
                initial={{ x: -50 }}
                animate={{ x: 0 }}
                transition={{ delay: 0.2 }}
              >
                å¤„ç†ç»“æœ
              </motion.h3>
              <motion.div
                className="results-stats"
                initial={{ x: 50 }}
                animate={{ x: 0 }}
                transition={{ delay: 0.3 }}
              >
                <span className="success">âœ“ æˆåŠŸ: {successCount}</span>
                <span className="error">âœ— å¤±è´¥: {failCount}</span>
              </motion.div>
            </div>

            {successCount > 0 && (
              <motion.button
                className="download-all-btn memphis-btn"
                onClick={handleDownloadAll}
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                transition={{ delay: 0.4, type: 'spring', stiffness: 200 }}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
              >
                ğŸ’¾ ä¸‹è½½å…¨éƒ¨ç»“æœ
              </motion.button>
            )}

            <div className="results-list">
              {results.map((result, index) => (
                <motion.div
                  key={index}
                  className={`result-item ${result.success ? 'success' : 'error'}`}
                  initial={{ opacity: 0, x: result.success ? -50 : 50 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{
                    delay: 0.5 + index * 0.1,
                    type: 'spring',
                    stiffness: 100
                  }}
                >
                  <div className="result-header">
                    <div className="result-filename">
                      <span className={`status-icon ${result.success ? 'success' : 'error'}`}>
                        {result.success ? 'âœ“' : 'âœ—'}
                      </span>
                      {result.filename}
                    </div>
                    {result.success && (
                      <motion.button
                        className="download-btn memphis-btn secondary"
                        onClick={() => handleDownloadSingle(result)}
                        whileHover={{ scale: 1.1 }}
                        whileTap={{ scale: 0.9 }}
                      >
                        ğŸ“¥ ä¸‹è½½
                      </motion.button>
                    )}
                  </div>
                  {result.success ? (
                    <div className="result-content">
                      <MarkdownRenderer content={result.markdown} />
                    </div>
                  ) : (
                    <div className="result-error">
                      é”™è¯¯: {result.error}
                    </div>
                  )}
                </motion.div>
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

export default BatchImageOCR;
