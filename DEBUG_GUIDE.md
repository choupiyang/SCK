# OCR 调试指南

## 问题诊断

我已经增强了服务器的日志输出，现在重新处理图片时会显示详细的诊断信息。

## 如何诊断问题

### 1. 重启服务器

```bash
cd f:\object\SCK
npm run dev
```

### 2. 重新处理图片

上传并处理 `(3).png` 和 `(4).png`，观察服务器日志输出。

### 3. 查看日志输出

现在每个步骤都会输出详细信息：

#### OCR 识别阶段：
```
→ 开始调用 DeepSeek OCR API...
✓ DeepSeek OCR 调用成功
→ OCR 识别内容长度: 1234 字符
→ 内容预览 (前150字符): # 标题内容...
```

#### GLM 提炼阶段：
```
→ GLM 提炼输入长度: 1234 字符
✓ GLM 提炼完成
→ GLM 提炼输出长度: 1156 字符
→ 内容变化率: 93.7%
```

### 4. 常见问题诊断

#### 问题 A: (3).png 内容不对

**可能原因 1: OCR 识别错误**
- 日志会显示 OCR 识别的内容长度和预览
- 检查预览内容是否正确
- 如果 OCR 结果本身就错了，问题在于 DeepSeek OCR API

**可能原因 2: GLM 提炼过度**
- 对比"内容变化率"
- 如果变化率过低（< 50%），说明 GLM 删除了太多内容
- 解决方案：调整 GLM_REFINE_PROMPT

**可能原因 3: 图片质量问题**
- 图片分辨率过低
- 文字模糊或不清晰
- 尝试提高图片质量重新识别

#### 问题 B: (4).png 提炼失败

**可能原因 1: API 超时**
```
❌ GLM 提炼 API 调用失败
   错误类型: ECONNABORTED
   错误信息: timeout of 60000ms exceeded
```
- 解决方案：图片太大或内容太复杂，增加 timeout

**可能原因 2: 内容为空**
```
⚠️  警告: OCR 识别结果为空
```
或
```
⚠️  警告: OCR 识别内容过短 ( 5 字符)
OCR 内容为空或过短，跳过提炼步骤
```
- 解决方案：图片可能没有文字或文字无法识别

**可能原因 3: API 错误**
```
❌ GLM 提炼 API 调用失败
   错误类型: ERR_BAD_REQUEST
   错误信息: { error: { message: 'Invalid API key', ... } }
```
- 解决方案：检查 GLM_API_KEY 是否正确

**可能原因 4: GLM 返回空内容**
```
⚠️  GLM 返回内容为空，使用原始 OCR 结果
```
- GLM API 可能出错，但会自动降级使用原始 OCR 结果

## 调试步骤

### 步骤 1: 检查 OCR 结果

查看日志中的"内容预览"，确认 DeepSeek OCR 是否正确识别了图片。

如果 OCR 结果就不对，问题在于：
- DeepSeek OCR API 的识别能力
- 图片质量问题

### 步骤 2: 检查 GLM 提炼

对比 OCR 结果和最终 MD 文件的内容：
- 如果内容被大幅删减 → GLM_REFINE_PROMPT 太激进
- 如果内容格式错误 → GLM 理解有误
- 如果完全无法识别 → 图片问题

### 步骤 3: 临时禁用 GLM

如果要测试是否是 GLM 的问题，可以临时禁用：

在 `.env` 文件中注释掉：
```bash
# GLM_API_KEY=your_key_here
```

重启服务器，再次测试，看直接 OCR 结果是否正确。

## 优化建议

### 如果 GLM 删除了太多内容

编辑 `.env` 文件，调整 GLM_REFINE_PROMPT：

```bash
GLM_REFINE_PROMPT=你是一个 Markdown 内容提炼专家。请移除 OCR 识别中的开场白和解释性文字，但保留所有实际内容。不要删除任何标题、段落、列表、代码块等内容。
```

### 如果经常超时

在 `server/index.js` 中增加超时时间：

```javascript
timeout: 120000, // 120秒超时
```

### 如果 OCR 识别不准

考虑：
1. 提高图片分辨率
2. 确保图片清晰度
3. 调整图片对比度
4. 尝试其他 OCR API

## 下一步

请重新处理图片，并将完整的日志输出发给我，我可以帮您分析具体是哪个环节出了问题。
